---
- name: Gather release versions
  setup_yaml:

- name: Check mandatory variables for this role are set
  assert:
    fail_msg: "not all mandatory variables given, check role documentation"
    quiet: yes
    that:
      - metal_stack_cloud_accounting_sender_image_name is defined
      - metal_stack_cloud_accounting_sender_image_tag is defined
      - metal_stack_cloud_accounting_reporter_image_name is defined
      - metal_stack_cloud_accounting_reporter_image_tag is defined
      - metal_stack_cloud_nsq_image_name is defined
      - metal_stack_cloud_nsq_image_tag is defined

- name: Create namespace
  k8s:
    definition:
      apiVersion: v1
      kind: Namespace
      metadata:
        name: "{{ accounting_namespace }}"
        labels:
          name: "{{ accounting_namespace }}"

- name: Deploy nsq
  include_role:
    name: metal-stack-cloud-ansible-roles/roles/nsq
  vars:
    nsq_name: "{{ accounting_nsq_name }}"
    nsq_namespace: "{{ accounting_namespace }}"
    nsq_image_pull_policy: "{{ accounting_nsq_image_pull_policy }}"
    nsq_nsqd_resources: "{{ accounting_nsq_nsqd_resources }}"
    nsq_nsqd_data_size: "{{ accounting_nsq_nsqd_data_size }}"

- name: Deploy accounting
  k8s:
    definition: "{{ lookup('template', 'accounting.yaml') }}"
    namespace: "{{ accounting_namespace }}"
    apply: yes
